generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id             String            @id @default(cuid())
  casinoId       Int?              @unique
  firstName      String
  lastName       String
  phone          String?           @unique
  password       String
  balance        Int               @default(0)
  bonusBalance    Int      @default(0)  // Separate from real balance
  bonusTransactions BonusTransaction[]
  bonuses        Bonus[]
  totalBonusGiven Int      @default(0)
  totalTurnover   Int      @default(0)
  lastBonusClaimedAt DateTime?
  isFirstDepositBonusClaimed Boolean @default(false)
  promoCode      String?           @unique
  referredById   String?
  lockedBalance  Int               @default(0)
  totalDeposited Int               @default(0)
  totalWithdrawn Int               @default(0)
  gamesPlayed    Int               @default(0)
  wins           Int               @default(0)
  losses         Int               @default(0)
  isVerified     Boolean           @default(false)
  isBanned       Boolean           @default(false)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  lastActiveAt   DateTime?
  role           String            @default("user")
  isAI           Boolean           @default(false)
  transactionPassword String?
  hasTransactionPassword Boolean @default(false)
  dailyWithdrawCount Int @default(0)
  lastWithdrawDate DateTime?
  casinoGames    CasinoGame[]
  casinoSpins    CasinoSpin[]
  deposits       DepositRequest[]
  gameSessions   GameSession[]
  matchPlayers   MatchPlayer[]
  rooms          Room[]            @relation("RoomHost")
  participations RoomPlayer[]
  transactions   Transaction[]
  referredBy     User?             @relation("UserReferral", fields: [referredById], references: [id])
  referrals      User[]            @relation("UserReferral")
  withdraws      WithdrawRequest[]
  ewallets       EWallet[]
}

model Bonus {
  id              String             @id @default(cuid())
  userId          String
  type            String             // "first_deposit", "referral", "promo", "daily", "weekly", etc.
  amount          Int
  originalAmount  Int                // Original bonus amount before any deductions
  turnoverAmount  Int                // Required turnover amount (bonus * multiplier)
  currentTurnover Int                @default(0) // Current completed turnover
  status          String             @default("active") // active, completed, expired, cancelled
  isWithdrawable  Boolean            @default(false) // Whether bonus amount can be withdrawn
  expiresAt       DateTime?          // When bonus expires if not used
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  
  // Relations
  user            User               @relation(fields: [userId], references: [id])
  transactions    BonusTransaction[]
  
  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([expiresAt])
}

model BonusTransaction {
  id        String   @id @default(cuid())
  bonusId   String
  userId    String   // ADD THIS LINE
  type      String   // "bet", "win", "rollback", "expire", "cancel"
  amount    Int      // Amount affected
  turnover  Int      // Turnover contributed
  gameType  String?  // Casino game, sports, etc.
  matchId   String?
  metadata  Json?
  createdAt DateTime @default(now())
  
  bonus     Bonus    @relation(fields: [bonusId], references: [id])
  user      User     @relation(fields: [userId], references: [id]) // ADD THIS LINE
  
  @@index([bonusId])
  @@index([createdAt])
}
model SystemWallet {
  id        String   @id @default(cuid())
  balance   Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Room {
  id          String       @id @default(cuid())
  gameType    String?
  matchType   String       @default("target")
  targetScore Int          @default(30)
  maxPlayers  Int?
  isPublic    Boolean      @default(true)
  isInstant   Boolean      @default(false)
  entryFee    Int          @default(0)
  status      String       @default("WAITING")
  hostId      String?
  createdAt   DateTime     @default(now())
  host        User?        @relation("RoomHost", fields: [hostId], references: [id])
  players     RoomPlayer[]
}

model RoomPlayer {
  id       String   @id @default(cuid())
  roomId   String
  userId   String
  joinedAt DateTime @default(now())
  user     User     @relation(fields: [userId], references: [id])
  room     Room     @relation(fields: [roomId], references: [id])

  @@unique([roomId, userId])
}

model Match {
  id         String        @id @default(cuid())
  gameType   String
  stake      Int
  status     String
  roomId     String?
  createdAt  DateTime      @default(now())
  finishedAt DateTime?
  players    MatchPlayer[]
}

model MatchPlayer {
  id       String   @id @default(cuid())
  matchId  String
  userId   String
  isWinner Boolean?
  score    Int?
  user     User     @relation(fields: [userId], references: [id])
  match    Match    @relation(fields: [matchId], references: [id])

  @@unique([matchId, userId])
}

model DepositRequest {
  id         String    @id @default(cuid())
  userId     String
  method     String
  amount     Int
  trxId      String    @unique
  status     String    @default("pending")
  createdAt  DateTime  @default(now())
  approvedAt DateTime?
  user       User      @relation(fields: [userId], references: [id])

  @@index([status])
  @@index([createdAt])
}

model WithdrawRequest {
  id          String    @id @default(cuid())
  userId      String
  method      String
  amount      Int
  account     String
  status      String    @default("pending")
  createdAt   DateTime  @default(now())
  processedAt DateTime?
  user        User      @relation(fields: [userId], references: [id])

  @@index([status])
  @@index([createdAt])
}

model Transaction {
  id        String   @id @default(cuid())
  userId    String?
  type      String
  amount    Int
  status    String
  provider  String?
  reference String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
  metadata  Json?
}

model CasinoGame {
  id         String    @id @default(cuid())
  userId     String
  gameType   String
  stake      Int
  multiplier Float?
  matchId    String    @unique
  result     String?
  winAmount  Int?
  status     String    @default("WAITING")
  startedAt  DateTime  @default(now())
  finishedAt DateTime?
  user       User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([gameType])
}

model GameSession {
  id        String   @id @default(cuid())
  sessionId String   @unique
  userId    String
  gameCode  String
  balance   Int
  provider  String
  brandId   String
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])
}

model CasinoSpin {
  id        String   @id @default(cuid())
  userId    String
  gameCode  String
  gameName  String
  betAmount Int
  winAmount Int
  netResult Int
  gameRound String   @unique
  timestamp DateTime
  status    String   @default("PENDING")
  createdAt DateTime @default(now())
  matchId   String?
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([timestamp])
  @@index([gameCode])
  @@index([matchId])
  @@index([status])
  @@index([gameRound])
}

model EWallet {
  id             String   @id @default(cuid())
  userId         String
  type           String   // "bkash" or "nagad"
  accountNumber  String
  accountHolder  String
  isDefault      Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  user           User     @relation(fields: [userId], references: [id])
  
  // Change this: allow same number with different type for same user
  @@unique([userId, accountNumber, type])
  // Keep this: prevent same number+type across different users
  @@unique([accountNumber, type])
  @@index([userId])
  @@index([accountNumber])
}